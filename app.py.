# ==============================
# HandPD Random Forest Web-Friendly Version
# ==============================

import streamlit as st
import pandas as pd
import numpy as np
from sklearn.ensemble import RandomForestClassifier
from sklearn.model_selection import train_test_split
from sklearn.metrics import f1_score, roc_auc_score, confusion_matrix
import seaborn as sns
import matplotlib.pyplot as plt

st.title("HandPD Parkinson's Prediction Dashboard")

# ==============================
# Step 1: Upload CSV
# ==============================
uploaded_file = st.file_uploader("Upload Spiral_HandPD CSV", type="csv")
if uploaded_file is not None:
    spiral_df = pd.read_csv(uploaded_file)
    
    # Map CLASS_TYPE to 0=Healthy, 1=Parkinson's
    spiral_df['CLASS_TYPE'] = spiral_df['CLASS_TYPE'] - 1

    numeric_features = [
        'RMS', 'MAX_BETWEEN_ET_HT', 'MIN_BETWEEN_ET_HT', 
        'STD_DEVIATION_ET_HT', 'MRT', 'MAX_HT', 'MIN_HT', 'STD_HT', 
        'CHANGES_FROM_NEGATIVE_TO_POSITIVE_BETWEEN_ET_HT'
    ]

    st.subheader("Data Preview")
    st.dataframe(spiral_df.head())

    st.subheader("Class Distribution")
    st.bar_chart(spiral_df['CLASS_TYPE'].value_counts())

    # ==============================
    # Step 2: Feature Boxplots
    # ==============================
    st.subheader("Feature Boxplots by Class")
    for feature in numeric_features:
        fig, ax = plt.subplots(figsize=(6,4))
        sns.boxplot(x='CLASS_TYPE', y=feature, data=spiral_df, showfliers=True, ax=ax)
        sns.pointplot(x='CLASS_TYPE', y=feature, data=spiral_df, estimator=np.mean,
                      color='red', markers='D', scale=1.0, errorbar=None, ax=ax)
        ax.set_xticklabels(['Healthy', "Parkinson's"])
        ax.set_title(f"{feature} by Class")
        ax.set_xlabel("Class")
        ax.set_ylabel(feature)
        ax.text(0.7, spiral_df[feature].max()*0.95, "Red diamond = mean", color='red', fontsize=9)
        st.pyplot(fig)

    # ==============================
    # Step 3: Train Random Forest Model
    # ==============================
    X = spiral_df[numeric_features]
    y = spiral_df['CLASS_TYPE']

    X_train, X_test, y_train, y_test = train_test_split(X, y, test_size=0.2, random_state=42, stratify=y)
    clf = RandomForestClassifier(n_estimators=200, random_state=42)
    clf.fit(X_train, y_train)

    # Evaluate
    preds = clf.predict(X_test)
    probs = clf.predict_proba(X_test)[:,1]
    st.subheader("Model Performance")
    st.write("F1 Score:", round(f1_score(y_test, preds),3))
    st.write("ROC AUC:", round(roc_auc_score(y_test, probs),3))
    st.write("Confusion Matrix:", confusion_matrix(y_test, preds))

    # ==============================
    # Step 4: Predict New Sample
    # ==============================
    st.subheader("Predict New Sample")
    st.write("Enter feature values to predict class:")
    new_sample = {}
    for feature in numeric_features:
        new_sample[feature] = [st.number_input(feature, value=float(spiral_df[feature].mean()))]

    if st.button("Predict"):
        new_df = pd.DataFrame(new_sample)
        pred_class = clf.predict(new_df)[0]
        pred_prob = clf.predict_proba(new_df)[0]
        class_map = {0:"Healthy", 1:"Parkinson's"}
        st.write("Predicted class:", class_map[pred_class])
        st.write(f"Probability: Healthy={pred_prob[0]:.2f}, Parkinson's={pred_prob[1]:.2f}")
